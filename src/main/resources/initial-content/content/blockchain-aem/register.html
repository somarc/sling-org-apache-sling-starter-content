<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Blockchain AEM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-primary: #00d4aa;
            --accent-secondary: #7c3aed;
            --accent-tertiary: #f59e0b;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6b7280;
            --border-color: rgba(0, 212, 170, 0.2);
            --glow-primary: rgba(0, 212, 170, 0.3);
            --glow-secondary: rgba(124, 58, 237, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        
        /* Animated background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 170, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 170, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }
        
        .bg-glow {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(150px);
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }
        
        .bg-glow.teal {
            background: var(--accent-primary);
            top: -200px;
            right: -200px;
        }
        
        .bg-glow.purple {
            background: var(--accent-secondary);
            bottom: -200px;
            left: -200px;
        }
        
        /* Header - matches other Blockchain AEM pages */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(12px);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px var(--glow-primary);
        }
        
        .brand-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--bg-primary);
            stroke-width: 2;
            fill: none;
        }
        
        .brand-text {
            font-weight: 600;
            font-size: 17px;
            letter-spacing: -0.3px;
        }
        
        .brand-text span {
            color: var(--accent-primary);
        }
        
        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .logo span {
            color: var(--accent-primary);
        }
        
        /* Main content */
        .register-container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }
        
        .register-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 48px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .register-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .register-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 36px;
        }
        
        .register-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .register-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, #00b894 100%);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--glow-primary);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, #9333ea 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--glow-secondary);
        }
        
        .btn-metamask {
            background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
            color: white;
        }
        
        .btn-metamask:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(246, 133, 27, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-icon {
            font-size: 20px;
        }
        
        /* Info box */
        .info-box {
            background: rgba(0, 212, 170, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }
        
        .info-box-title {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-box-content {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.8;
        }
        
        .info-box-content ol {
            margin: 0;
            padding-left: 20px;
        }
        
        /* Back link */
        .back-link {
            display: block;
            text-align: center;
            margin-top: 24px;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .back-link:hover {
            color: var(--text-primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 48px;
            border-radius: 20px;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .modal-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .modal-message {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 24px;
            white-space: pre-line;
        }
        
        .modal-btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, #00b894 100%);
            color: var(--bg-primary);
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="bg-glow teal"></div>
    <div class="bg-glow purple"></div>
    
    <header class="header">
        <a href="/starter.html" class="brand">
            <div class="brand-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div class="brand-text">Blockchain <span>AEM</span></div>
        </a>
        <a href="/starter.html" class="back-link">‚Üê Back to Login</a>
    </header>
    
    <div class="register-container">
        <div class="register-card">
            <div class="register-header">
                <div class="register-icon">üîê</div>
                <h1 class="register-title">Create Your Account</h1>
                <p class="register-subtitle">
                    Connect your wallet to create a Blockchain AEM author account.<br>
                    No passwords needed - just your wallet signature.
                </p>
            </div>
            
            <button id="btn-biometric" class="btn btn-primary">
                <span class="btn-icon">üëÜ</span>
                Register with Biometric
            </button>
            
            <button id="btn-metamask" class="btn btn-metamask">
                <span class="btn-icon">ü¶ä</span>
                Register with MetaMask
            </button>
            
            <div class="info-box">
                <div class="info-box-title">
                    <span>üìã</span> What happens next
                </div>
                <div class="info-box-content">
                    <ol>
                        <li>Create biometric credential or connect wallet</li>
                        <li>We'll create your author account</li>
                        <li>You'll be added to the administrators group</li>
                        <li>Sign in and start publishing content</li>
                    </ol>
                </div>
            </div>
            
            <a href="/content/blockchain-aem/dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div id="modal-icon" class="modal-icon"></div>
            <h2 id="modal-title" class="modal-title"></h2>
            <p id="modal-message" class="modal-message"></p>
            <button id="modal-btn" class="modal-btn" onclick="closeModal()">OK</button>
        </div>
    </div>
    
    <script>
        // =============================================
        // Modal Functions
        // =============================================
        function showStatus(icon, title, message, showOk = false) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-btn').style.display = showOk ? 'inline-block' : 'none';
            document.getElementById('modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // =============================================
        // Biometric Wallet Creation (Inlined)
        // =============================================
        async function keccak256(data) {
            // For demo: use SHA-256 (in production use ethers.utils.keccak256)
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }
        
        async function deriveEthereumAddress(pubKey) {
            // Extract coordinates (skip 0x04 prefix if present)
            const start = pubKey[0] === 0x04 ? 1 : 0;
            const qx = pubKey.slice(start, start + 32);
            const qy = pubKey.slice(start + 32, start + 64);
            
            const combined = new Uint8Array(64);
            combined.set(qx, 0);
            combined.set(qy, 32);
            
            const hash = await keccak256(combined);
            return '0x' + hash.slice(0, 40);
        }
        
        async function createBiometricWallet() {
            if (!('PublicKeyCredential' in window)) {
                throw new Error('Biometrics not supported on this device');
            }
            
            showStatus('üîê', 'Initializing...', 'Preparing biometric registration...');
            
            const challenge = crypto.getRandomValues(new Uint8Array(32));
            
            const options = {
                challenge: challenge,
                rp: {
                    name: 'Blockchain AEM',
                    id: window.location.hostname
                },
                user: {
                    id: crypto.getRandomValues(new Uint8Array(16)),
                    name: 'author@blockchain-aem.local',
                    displayName: 'AEM Author'
                },
                pubKeyCredParams: [{ alg: -7, type: 'public-key' }],
                authenticatorSelection: {
                    authenticatorAttachment: 'platform',
                    userVerification: 'required'
                },
                timeout: 60000,
                attestation: 'direct'
            };
            
            showStatus('üëÜ', 'Scan Biometric', 'Please scan your fingerprint or face...');
            
            const credential = await navigator.credentials.create({ publicKey: options });
            
            showStatus('üîë', 'Generating Wallet...', 'Deriving Ethereum address from public key...');
            
            // Get public key
            let pubKey;
            if (credential.response.getPublicKey) {
                pubKey = new Uint8Array(credential.response.getPublicKey());
            } else {
                throw new Error('Could not extract public key from credential');
            }
            
            const address = await deriveEthereumAddress(pubKey);
            
            console.log('‚úÖ Biometric wallet created:');
            console.log('  Address:', address);
            console.log('  Credential ID:', credential.id);
            console.log('  Public Key:', pubKey.length, 'bytes');
            
            return {
                address: address,
                credentialId: credential.id,
                pubKey: Array.from(pubKey),
                rawId: Array.from(new Uint8Array(credential.rawId))
            };
        }
        
        async function registerWithBackend(walletData) {
            showStatus('üì°', 'Registering...', 'Registering wallet with validators...');
            
            const response = await fetch('/bin/blockchain-aem/biometric-register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    address: walletData.address,
                    credentialId: walletData.credentialId,
                    pubKey: walletData.pubKey,
                    rawId: walletData.rawId
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Registration failed');
            }
            
            return await response.json();
        }
        
        // =============================================
        // Event Handlers
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            const biometricBtn = document.getElementById('btn-biometric');
            const metamaskBtn = document.getElementById('btn-metamask');
            
            // Biometric Registration
            biometricBtn.addEventListener('click', async function() {
                try {
                    biometricBtn.disabled = true;
                    biometricBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Initializing...';
                    
                    // Step 1: Create wallet
                    const walletData = await createBiometricWallet();
                    
                    // Step 2: Register with backend
                    await registerWithBackend(walletData);
                    
                    // Step 3: Store locally
                    localStorage.setItem('blockchain_aem_biometric_wallet', walletData.address);
                    localStorage.setItem('blockchain_aem_biometric_credential_id', walletData.credentialId);
                    const pubKeyBase64 = btoa(String.fromCharCode.apply(null, walletData.pubKey));
                    localStorage.setItem('blockchain_aem_biometric_pubkey', pubKeyBase64);
                    
                    // Success!
                    showStatus('‚úÖ', 'Registration Successful!', 
                        'Wallet: ' + walletData.address.substring(0, 12) + '...\n\n' +
                        'Your biometric credential is registered.\n' +
                        'You can now sign in with Face ID/Touch ID.\n\n' +
                        'Redirecting to login...', false);
                    
                    setTimeout(() => {
                        window.location.href = '/content/blockchain-aem/dashboard.html';
                    }, 3000);
                    
                } catch (error) {
                    biometricBtn.disabled = false;
                    biometricBtn.innerHTML = '<span class="btn-icon">üëÜ</span> Register with Biometric';
                    
                    if (error.name === 'NotAllowedError') {
                        showStatus('‚ùå', 'Registration Cancelled', 
                            'You cancelled the biometric registration.', true);
                    } else {
                        showStatus('‚ùå', 'Registration Failed', 
                            'Error: ' + error.message, true);
                    }
                }
            });
            
            // MetaMask Registration
            metamaskBtn.addEventListener('click', async function() {
                try {
                    if (!window.ethereum) {
                        showStatus('ü¶ä', 'MetaMask Not Found', 
                            'Please install the MetaMask browser extension.', true);
                        return;
                    }
                    
                    metamaskBtn.disabled = true;
                    metamaskBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Connecting...';
                    
                    showStatus('ü¶ä', 'Opening MetaMask...', 
                        'Please approve the connection in MetaMask.');
                    
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    const address = accounts[0];
                    
                    showStatus('‚úçÔ∏è', 'Sign Message', 
                        'Please sign the registration message in MetaMask.');
                    
                    const message = 'Register with Blockchain AEM\nWallet: ' + address + '\nTimestamp: ' + Date.now();
                    const signature = await window.ethereum.request({
                        method: 'personal_sign',
                        params: [message, address]
                    });
                    
                    showStatus('üîê', 'Creating Account...', 
                        'Registering your wallet...');
                    
                    const response = await fetch('/bin/blockchain-aem/register-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            address: address, 
                            signature: signature,
                            message: message,
                            type: 'metamask'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Registration failed: ' + response.statusText);
                    }
                    
                    localStorage.setItem('blockchain_aem_wallet', address);
                    
                    showStatus('‚úÖ', 'Registration Successful!', 
                        'Wallet: ' + address.substring(0, 12) + '...\n\n' +
                        'You can now sign in with MetaMask.\n\n' +
                        'Redirecting to login...', false);
                    
                    setTimeout(() => {
                        window.location.href = '/content/blockchain-aem/dashboard.html';
                    }, 3000);
                    
                } catch (error) {
                    metamaskBtn.disabled = false;
                    metamaskBtn.innerHTML = '<span class="btn-icon">ü¶ä</span> Register with MetaMask';
                    
                    if (error.code === 4001) {
                        showStatus('‚ùå', 'Cancelled', 
                            'You rejected the request in MetaMask.', true);
                    } else {
                        showStatus('‚ùå', 'Registration Failed', 
                            'Error: ' + error.message, true);
                    }
                }
            });
        });
    </script>
</body>
</html>
