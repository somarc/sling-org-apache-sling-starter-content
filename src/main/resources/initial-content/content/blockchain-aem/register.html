<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Blockchain AEM</title>
    <link rel="stylesheet" href="/apps/blockchain-aem/components/login/clientlibs/css/login-styles.css">
    <style>
        .register-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px;
        }
        
        .register-box {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .register-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .register-title {
            font-size: 32px;
            font-weight: 300;
            color: #ffffff;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .register-subtitle {
            font-size: 16px;
            color: #a0a0b0;
            text-align: center;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        .register-button {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 500;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .register-button.metamask {
            background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
            color: white;
        }
        
        .register-button.biometric {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .register-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(103, 126, 234, 0.3);
        }
        
        .register-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-box {
            background: rgba(103, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            color: #a0a0b0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .back-link {
            display: block;
            text-align: center;
            margin-top: 30px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    <div class="blockchain-pattern"></div>
    
    <div class="register-container">
        <div class="register-box">
            <div class="register-icon">üîê</div>
            <h1 class="register-title">Create Your Account</h1>
            <p class="register-subtitle">
                Connect your wallet to create a Blockchain AEM author account.<br>
                No passwords needed - just your wallet signature.
            </p>
            
            <button id="register-metamask-btn" class="register-button metamask">
                <span style="font-size: 24px;">ü¶ä</span>
                Register with MetaMask
            </button>
            
            <button id="register-biometric-btn" class="register-button biometric">
                <span style="font-size: 24px;">üëÜ</span>
                Register with Biometric
            </button>
            
            <div class="info-box">
                <strong>What happens next:</strong><br>
                1. Connect your wallet or create biometric credential<br>
                2. We'll create your author account<br>
                3. You'll be added to the administrators group<br>
                4. You can then sign in and publish content
            </div>
            
            <a href="/starter.html" class="back-link">‚Üê Back to Sign In</a>
        </div>
    </div>
    
    <!-- Modal for status messages -->
    <div id="status-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding:40px; border-radius:20px; max-width:500px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <div id="status-icon" style="font-size:64px; margin-bottom:20px;"></div>
            <h2 id="status-title" style="color:#fff; margin:0 0 10px 0; font-size:24px;"></h2>
            <p id="status-message" style="color:#a0a0b0; margin:0 0 20px 0; font-size:16px; white-space: pre-line;"></p>
            <button id="status-ok-btn" onclick="document.getElementById('status-modal').style.display='none'" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; padding:12px 30px; border-radius:8px; font-size:16px; cursor:pointer; display:none;">OK</button>
        </div>
    </div>
    
    <script src="/apps/blockchain-aem/components/login/clientlibs/js/biometric-wallet-creation.js"></script>
    <script>
        function showStatus(icon, title, message, showOkButton) {
            const modal = document.getElementById('status-modal');
            document.getElementById('status-icon').textContent = icon;
            document.getElementById('status-title').textContent = title;
            document.getElementById('status-message').textContent = message;
            document.getElementById('status-ok-btn').style.display = showOkButton ? 'inline-block' : 'none';
            modal.style.display = 'flex';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const metamaskBtn = document.getElementById('register-metamask-btn');
            const biometricBtn = document.getElementById('register-biometric-btn');
            
            // MetaMask registration
            metamaskBtn.addEventListener('click', async function() {
                const btn = metamaskBtn;
                
                try {
                    if (!window.ethereum) {
                        showStatus('ü¶ä', 'MetaMask Not Found', 
                            'Please install the MetaMask browser extension to continue.', true);
                        window.open('https://metamask.io', '_blank');
                        return;
                    }
                    
                    btn.disabled = true;
                    btn.innerHTML = '<span style="font-size: 24px;">‚è≥</span> Opening MetaMask...';
                    
                    // Step 1: Request accounts
                    showStatus('ü¶ä', 'Opening MetaMask...', 
                        'Please check your MetaMask extension and approve the connection request.', false);
                    
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    const userAddress = accounts[0];
                    
                    // Step 2: Sign registration message
                    showStatus('‚úçÔ∏è', 'Sign Registration Message', 
                        'Please sign the message in MetaMask to create your account.', false);
                    
                    const message = 'Register with Blockchain AEM\nWallet: ' + userAddress + '\nTimestamp: ' + Date.now();
                    const signature = await window.ethereum.request({
                        method: 'personal_sign',
                        params: [message, userAddress]
                    });
                    
                    // Step 3: Send to backend for user creation
                    showStatus('üîê', 'Creating Account...', 
                        'Creating your author account in the repository...', false);
                    
                    const response = await fetch('/bin/blockchain-aem/register-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            address: userAddress, 
                            signature: signature,
                            message: message,
                            type: 'metamask'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Registration failed: ' + response.statusText);
                    }
                    
                    const result = await response.json();
                    
                    // Success!
                    showStatus('‚úÖ', 'Account Created!', 
                        'Wallet: ' + userAddress.substring(0, 10) + '...\n\n' +
                        'You can now sign in with MetaMask.\n\n' +
                        'Redirecting to login page...', false);
                    
                    localStorage.setItem('blockchain_aem_wallet', userAddress);
                    
                    setTimeout(function() {
                        window.location.href = '/starter.html';
                    }, 3000);
                    
                } catch (error) {
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 24px;">ü¶ä</span> Register with MetaMask';
                    
                    if (error.code === 4001) {
                        showStatus('‚ùå', 'Registration Cancelled', 
                            'You rejected the request in MetaMask.', true);
                    } else {
                        showStatus('‚ùå', 'Registration Failed', 
                            'Error: ' + error.message, true);
                    }
                }
            });
            
            // Biometric registration
            biometricBtn.addEventListener('click', async function() {
                const btn = biometricBtn;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<span style="font-size: 24px;">‚è≥</span> Initializing...';
                    
                    // Use the biometric wallet creation flow
                    const walletData = await setupBiometricWallet(showStatus);
                    
                    // Send to backend for user creation
                    showStatus('üîê', 'Creating Account...', 
                        'Creating your author account in the repository...', false);
                    
                    const response = await fetch('/bin/blockchain-aem/register-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            address: walletData,
                            type: 'biometric',
                            credentialId: localStorage.getItem('blockchain_aem_biometric_credential_id')
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Registration failed: ' + response.statusText);
                    }
                    
                    // Success!
                    showStatus('‚úÖ', 'Account Created!', 
                        'Your biometric wallet is registered.\n\n' +
                        'You can now sign in with your biometric.\n\n' +
                        'Redirecting to login page...', false);
                    
                    setTimeout(function() {
                        window.location.href = '/starter.html';
                    }, 3000);
                    
                } catch (error) {
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size: 24px;">üëÜ</span> Register with Biometric';
                    
                    if (error.name === 'NotAllowedError') {
                        showStatus('‚ùå', 'Registration Cancelled', 
                            'You cancelled the biometric registration.', true);
                    } else {
                        showStatus('‚ùå', 'Registration Failed', 
                            'Error: ' + error.message, true);
                    }
                }
            });
        });
    </script>
</body>
</html>

