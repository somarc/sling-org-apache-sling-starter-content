<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat | Blockchain AEM</title>
    <!-- IMMEDIATE auth check - runs before page renders -->
    <script>
    (function() {
        const hasAuthCookie = document.cookie.split(';').some(c => c.trim().startsWith('blockchain.aem.auth='));
        const hasLocalWallet = localStorage.getItem('blockchain_aem_wallet') || 
                               localStorage.getItem('blockchain_aem_biometric_wallet');
        
        if (!hasAuthCookie && !hasLocalWallet) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/system/sling/info.sessionInfo.json', false);
            try {
                xhr.send();
                if (xhr.status === 200) {
                    var info = JSON.parse(xhr.responseText);
                    if (info.userID && info.userID !== 'anonymous') return;
                }
            } catch (e) {}
            window.location.replace('/starter.html');
        }
    })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Cyberpunk-inspired dark theme with teal/cyan accents */
            --bg-deep: #0a0e14;
            --bg-surface: #111820;
            --bg-elevated: #1a2332;
            --bg-hover: #243044;
            --border-subtle: #2a3a4d;
            --border-accent: #00d4aa;
            --text-primary: #e8eef4;
            --text-secondary: #8899a8;
            --text-muted: #5c6d7e;
            --accent-primary: #00d4aa;
            --accent-secondary: #00b894;
            --accent-tertiary: #0984e3;
            --status-success: #00d4aa;
            --status-warning: #ffc048;
            --status-error: #ff6b6b;
            --glow-primary: rgba(0, 212, 170, 0.3);
            --glow-secondary: rgba(9, 132, 227, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation Header */
        .nav-header {
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-tertiary) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px var(--glow-primary);
        }

        .brand-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--bg-deep);
            stroke-width: 2;
            fill: none;
        }

        .brand-text {
            font-weight: 600;
            font-size: 17px;
            letter-spacing: -0.3px;
        }

        .brand-text span {
            color: var(--accent-primary);
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent-primary);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Main Content */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }

        .page-header {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }

        .mode-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .mode-toggle-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .mode-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .mode-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-hover);
            transition: 0.3s;
            border-radius: 30px;
            border: 1px solid var(--border-subtle);
        }

        .mode-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .mode-toggle input:checked + .mode-toggle-slider {
            background-color: rgba(0, 212, 170, 0.2);
            border-color: var(--accent-primary);
        }

        .mode-toggle input:checked + .mode-toggle-slider:before {
            transform: translateX(30px);
            background-color: var(--accent-primary);
        }

        .mode-indicator {
            font-size: 0.85rem;
            color: var(--accent-primary);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .mode-indicator.agent-mode {
            color: var(--accent-tertiary);
        }

        h1 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 12px;
            vertical-align: middle;
            font-family: 'JetBrains Mono', monospace;
        }

        .status-connected {
            background: rgba(0, 212, 170, 0.15);
            color: var(--status-success);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .status-disconnected {
            background: rgba(255, 107, 107, 0.15);
            color: var(--status-error);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .chat-container {
            flex: 1;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 500px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
        }

        .message.assistant .message-avatar {
            background: var(--bg-elevated);
            border: 1px solid var(--border-accent);
        }

        .message-content {
            flex: 1;
            max-width: 75%;
        }

        .message.user .message-content {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            color: var(--bg-deep);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .message.user .message-time {
            text-align: right;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }

        .chat-input-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }

        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            transition: border-color 0.3s;
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-deep);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
            height: 50px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .welcome-message h2 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.5rem;
        }

        .welcome-message p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .welcome-message ul {
            text-align: left;
            display: inline-block;
            margin: 12px 0;
        }

        .welcome-message li {
            margin: 8px 0;
        }

        .example-queries {
            margin-top: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .example-query {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85rem;
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-query:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            color: var(--status-error);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid var(--status-error);
        }

        code {
            background: var(--bg-elevated);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--accent-primary);
        }

        .message.assistant .message-bubble pre {
            background: var(--bg-deep);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 0.9em;
            border: 1px solid var(--border-subtle);
        }

        .message.assistant .message-bubble pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        /* Markdown styling */
        .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4 {
            color: var(--text-primary);
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .message-bubble h1 { font-size: 1.3em; border-bottom: 1px solid var(--border-accent); padding-bottom: 8px; }
        .message-bubble h2 { font-size: 1.2em; color: var(--accent-primary); }
        .message-bubble h3 { font-size: 1.1em; color: var(--accent-tertiary); }

        .message-bubble ul, .message-bubble ol { margin: 12px 0; padding-left: 24px; }
        .message-bubble li { margin: 6px 0; }

        .message-bubble blockquote {
            border-left: 3px solid var(--accent-primary);
            background: rgba(0, 212, 170, 0.05);
            padding: 12px 16px;
            margin: 12px 0;
            color: var(--text-secondary);
        }

        .message-bubble table { border-collapse: collapse; width: 100%; margin: 12px 0; }
        .message-bubble th, .message-bubble td { border: 1px solid var(--border-subtle); padding: 8px 12px; text-align: left; }
        .message-bubble th { background: var(--bg-elevated); color: var(--accent-primary); }

        .message-bubble a {
            color: var(--accent-primary);
            text-decoration: none;
            border-bottom: 1px solid transparent;
        }
        .message-bubble a:hover { border-bottom-color: var(--accent-primary); }

        .code-block-wrapper { position: relative; margin: 12px 0; }
        .copy-code-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }
        .code-block-wrapper:hover .copy-code-button { opacity: 1; }
        .copy-code-button:hover { background: var(--bg-hover); color: var(--accent-primary); }
        .copy-code-button.copied { background: var(--status-success); color: var(--bg-deep); }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <a href="/content/blockchain-aem/dashboard.html" class="nav-brand">
            <div class="brand-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div class="brand-text">Blockchain <span>AEM</span></div>
        </a>
        <div class="nav-links">
            <a href="/content/blockchain-aem/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/content/blockchain-aem/editor.html" class="nav-link">Editor</a>
            <a href="/content/blockchain-aem/viewer.html" class="nav-link">Viewer</a>
            <a href="/content/blockchain-aem/agentic-chat.html" class="nav-link active">AI Chat</a>
        </div>
        <div class="nav-user">
            <div class="user-avatar" id="user-avatar" title="Click to sign out">üë§</div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>
                ü§ñ AI Chat
                <span class="status-badge" id="statusBadge">Checking...</span>
            </h1>
            <p class="tagline">AI-Native Oak & Sling ‚Ä¢ RAG-Indexed Codebase ‚Ä¢ Real-Time Log Analysis ‚Ä¢ Agentic Architecture</p>
            <div class="mode-toggle-container">
                <span class="mode-toggle-label">Chat Mode:</span>
                <label class="mode-toggle">
                    <input type="checkbox" id="agentModeToggle" onchange="toggleAgentMode()">
                    <span class="mode-toggle-slider"></span>
                </label>
                <span class="mode-indicator" id="modeIndicator">User ‚Üî LLM</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message" id="welcomeMessage">
                    <h2>üöÄ Welcome to AI-Native Oak</h2>
                    <p id="welcomeDescription"><strong>First-of-its-kind:</strong> JCR with embedded AI agents for real-time troubleshooting, code exploration, and system insights.</p>
                    <p><strong>Capabilities:</strong></p>
                    <ul style="text-align: left; display: inline-block; margin: 12px 0;">
                        <li>üß† <strong>RAG-Indexed Codebase</strong> - Semantic search across Oak/Sling source</li>
                        <li>üìä <strong>Live Log Analysis</strong> - Real-time error detection and diagnosis</li>
                        <li>üîó <strong>Validator Connectivity</strong> - Network topology and consensus monitoring</li>
                        <li>ü§ù <strong>Agent-to-Agent Mode</strong> - Multi-agent collaboration for complex debugging</li>
                        <li>‚ö° <strong>Instant Answers</strong> - Powered by local Ollama LLM (no cloud dependency)</li>
                    </ul>
                    <p style="margin-top: 16px; color: #667eea; font-weight: 600;">Ask me anything about your blockchain AEM infrastructure!</p>
                    <p id="agentModeHint" style="display: none; color: #764ba2; font-weight: 600; margin-top: 12px;">
                        ü§ñ Agent-to-Agent Mode: Your agent will communicate with validator agents for collaborative troubleshooting.
                    </p>
                    <div class="example-queries">
                        <span class="example-query" onclick="sendExampleQuery(this)">What errors are in the logs?</span>
                        <span class="example-query" onclick="sendExampleQuery(this)">How does composite mount work?</span>
                        <span class="example-query" onclick="sendExampleQuery(this)">Explain HttpSegmentStoreSync</span>
                        <span class="example-query" onclick="sendExampleQuery(this)">What is the validator state?</span>
                        <span class="example-query" onclick="sendExampleQuery(this)" id="agentExample" style="display: none;">Discover available agents</span>
                        <span class="example-query" onclick="sendExampleQuery(this)" id="agentExample2" style="display: none;">Negotiate with validator agent</span>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <form class="chat-input-form" id="chatForm" onsubmit="sendMessage(event)">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ask a question about Oak, Sling, or troubleshooting..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                    </div>
                    <button type="submit" class="send-button" id="sendButton">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- üî• WOW: Marked.js for markdown + Highlight.js for syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
    
    <script>
        // üî• WOW: Configure marked.js with syntax highlighting
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {
                        console.error('Syntax highlighting error:', err);
                    }
                }
                return hljs.highlightAuto(code).value;
            }
        });
        
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const statusBadge = document.getElementById('statusBadge');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const agentModeToggle = document.getElementById('agentModeToggle');
        const modeIndicator = document.getElementById('modeIndicator');

        // Conversation history for agent-to-agent mode
        let conversationHistory = [];
        let isAgentMode = false;

        // Check service availability on load
        checkServiceStatus();

        function checkServiceStatus() {
            fetch('/v1/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: 'ping' })
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    // Admin access required
                    statusBadge.textContent = 'Admin Required';
                    statusBadge.className = 'status-badge status-disconnected';
                    return;
                }
                if (response.ok || response.status === 200) {
                    return response.json().then(data => {
                        statusBadge.textContent = 'Connected';
                        statusBadge.className = 'status-badge status-connected';
                    }).catch(() => {
                        statusBadge.textContent = 'Connected';
                        statusBadge.className = 'status-badge status-connected';
                    });
                } else {
                    statusBadge.textContent = 'Disconnected';
                    statusBadge.className = 'status-badge status-disconnected';
                }
            })
            .catch(() => {
                statusBadge.textContent = 'Disconnected';
                statusBadge.className = 'status-badge status-disconnected';
            });
        }

        function sendExampleQuery(element) {
            const query = element.textContent.trim();
            messageInput.value = query;
            sendMessage(new Event('submit'));
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        function toggleAgentMode() {
            isAgentMode = agentModeToggle.checked;
            const welcomeDescription = document.getElementById('welcomeDescription');
            const agentModeHint = document.getElementById('agentModeHint');
            const agentExample = document.getElementById('agentExample');
            const agentExample2 = document.getElementById('agentExample2');
            
            if (isAgentMode) {
                modeIndicator.textContent = 'Agent ‚Üî Agent';
                modeIndicator.classList.add('agent-mode');
                welcomeDescription.textContent = 'Enable agent-to-agent mode to have your Sling author agent communicate with validator agents for collaborative troubleshooting.';
                agentModeHint.style.display = 'block';
                if (agentExample) agentExample.style.display = 'inline-block';
                if (agentExample2) agentExample2.style.display = 'inline-block';
                // Clear conversation history when switching modes
                conversationHistory = [];
            } else {
                modeIndicator.textContent = 'User ‚Üî LLM';
                modeIndicator.classList.remove('agent-mode');
                welcomeDescription.textContent = 'Ask me anything about Oak internals, Sling state, validator connectivity, or log analysis.';
                agentModeHint.style.display = 'none';
                if (agentExample) agentExample.style.display = 'none';
                if (agentExample2) agentExample2.style.display = 'none';
                conversationHistory = [];
            }
        }

        function sendMessage(event) {
            event.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message || sendButton.disabled) {
                return;
            }

            // Hide welcome message immediately when user sends a message
            if (welcomeMessage && welcomeMessage.style.display !== 'none') {
                welcomeMessage.style.display = 'none';
            }

            // Store message for conversation history
            const userMessage = message;
            
            // Add user message
            addMessage('user', userMessage);
            messageInput.value = '';
            adjustTextareaHeight();

            // Show typing indicator
            showTypingIndicator();

            // Disable input
            sendButton.disabled = true;
            messageInput.disabled = true;

            // Build request body based on mode
            const requestBody = {
                query: userMessage
            };

            if (isAgentMode) {
                // Agent-to-agent mode: include conversation history and agent context
                requestBody.context = {
                    agentToAgent: true,
                    conversationHistory: conversationHistory
                };
            }

            // Send to API
            fetch('/v1/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    // Authentication/Authorization required - redirect to login
                    window.location.href = '/system/sling/login?resource=' + encodeURIComponent(window.location.pathname);
                    throw new Error('Admin access required');
                }
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received response:', data);
                hideTypingIndicator();
                
                // API returns {answer, sources, confidence}
                let responseText = data.answer || data.response || data.message;
                
                console.log('Response text:', responseText);
                
                // Update conversation history for agent-to-agent mode
                if (isAgentMode) {
                    conversationHistory.push({
                        role: 'user',
                        content: userMessage
                    });
                    conversationHistory.push({
                        role: 'assistant',
                        content: responseText
                    });
                }
                
                // If agent-to-agent mode, show agent metadata if available
                if (isAgentMode && data.agentMetadata) {
                    responseText += '\n\n--- Agent Info ---\n';
                    if (data.agentMetadata.respondingAgentId) {
                        responseText += `Responding Agent: ${data.agentMetadata.respondingAgentId}\n`;
                    }
                    if (data.agentMetadata.respondingAgentType) {
                        responseText += `Agent Type: ${data.agentMetadata.respondingAgentType}\n`;
                    }
                }
                
                // If we have sources, append them
                if (data.sources && data.sources.length > 0) {
                    responseText += '\n\nüìö Sources:';
                    data.sources.forEach((source, idx) => {
                        responseText += `\n${idx + 1}. ${source.endpoint || source.type || 'Unknown'}`;
                        if (source.data) {
                            responseText += ` - ${source.data}`;
                        }
                    });
                }
                
                // Fallback to JSON if no answer found
                if (!responseText) {
                    console.warn('No answer found in response, using JSON fallback');
                    responseText = JSON.stringify(data, null, 2);
                }
                
                console.log('Adding message with text length:', responseText.length);
                addMessage('assistant', responseText);
            })
            .catch(error => {
                hideTypingIndicator();
                addMessage('assistant', `‚ùå Error: ${error.message}\n\nPlease ensure the oak-segment-agentic bundle is installed and Ollama is running.`, true);
            })
            .finally(() => {
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            });
        }

        function addMessage(role, content, isError = false) {
            console.log('addMessage called:', { role, contentLength: content.length, isError });
            
            // Ensure welcome message is hidden
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            try {
                if (isError) {
                    bubble.innerHTML = `<div class="error-message">${escapeHtml(content)}</div>`;
                } else {
                    // Format code blocks and preserve formatting
                    bubble.innerHTML = formatMessage(content);
                }
            } catch (e) {
                console.error('Error formatting message:', e);
                bubble.textContent = content; // Fallback to plain text
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();

            contentDiv.appendChild(bubble);
            contentDiv.appendChild(time);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            chatMessages.appendChild(messageDiv);
            console.log('Message added to DOM, element:', messageDiv);
            console.log('Chat messages container has', chatMessages.children.length, 'children');
            
            // Force a reflow to ensure rendering
            messageDiv.offsetHeight;
            
            // Scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }

        function formatMessage(text) {
            try {
                // üî• WOW: Use marked.js for full markdown rendering with syntax highlighting!
                let html = marked.parse(text);
                
                // üî• WOW: Add copy buttons to code blocks
                html = addCopyButtonsToCodeBlocks(html);
                
                return html;
            } catch (e) {
                console.error('Markdown parsing error:', e);
                // Fallback to basic formatting if marked.js fails
                return basicFormatMessage(text);
            }
        }
        
        function addCopyButtonsToCodeBlocks(html) {
            // Wrap code blocks with copy button
            return html.replace(/<pre><code([^>]*)>([\s\S]*?)<\/code><\/pre>/g, function(match, attrs, code) {
                const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
                return `
                    <div class="code-block-wrapper">
                        <button class="copy-code-button" onclick="copyCode('${codeId}')">
                            üìã Copy
                        </button>
                        <pre><code${attrs} id="${codeId}">${code}</code></pre>
                    </div>
                `;
            });
        }
        
        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            if (!codeElement) return;
            
            // Get text content (strips HTML)
            const code = codeElement.textContent;
            
            // Copy to clipboard
            navigator.clipboard.writeText(code).then(() => {
                // Find the button
                const wrapper = codeElement.closest('.code-block-wrapper');
                const button = wrapper.querySelector('.copy-code-button');
                
                // Visual feedback
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }
        
        function basicFormatMessage(text) {
            // Fallback: basic formatting without marked.js
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            });
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator active';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ü§ñ';
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(typingDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                const messageDiv = indicator.closest('.message');
                if (messageDiv) {
                    messageDiv.remove();
                } else {
                    // Fallback to old method
                    indicator.parentElement.parentElement.remove();
                }
            }
        }

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
        }

        // Auto-adjust textarea height
        messageInput.addEventListener('input', adjustTextareaHeight);

        // Logout handler
        document.getElementById('user-avatar').addEventListener('click', () => {
            if (confirm('Sign out of Blockchain AEM?')) {
                localStorage.removeItem('blockchain_aem_wallet');
                localStorage.removeItem('blockchain_aem_biometric_wallet');
                localStorage.removeItem('blockchain_aem_biometric_credential_id');
                localStorage.removeItem('blockchain_aem_biometric_pubkey');
                window.location.href = '/system/sling/logout?resource=/starter.html';
            }
        });
    </script>
</body>
</html>

