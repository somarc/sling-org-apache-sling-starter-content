<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish to Oak Chain - MetaMask Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.3.0/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: #666;
            font-size: 1.1rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .wallet-status {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-status.disconnected {
            background: #fed7d7;
            border-left: 4px solid #f56565;
        }

        .wallet-status.connected {
            background: #c6f6d5;
            border-left: 4px solid #48bb78;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            margin-top: 10px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
            font-size: 1rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            font-family: inherit;
            resize: vertical;
        }

        .tier-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .tier-option {
            padding: 20px;
            border: 3px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .tier-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .tier-option.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .tier-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .tier-price {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .tier-delay {
            font-size: 0.875rem;
            color: #718096;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.metamask {
            background: linear-gradient(135deg, #f6851b 0%, #e2761b 100%);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .alert.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .alert.info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .alert.show {
            display: block;
        }

        .cost-summary {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .cost-row.total {
            font-weight: 700;
            font-size: 1.2rem;
            padding-top: 10px;
            border-top: 2px solid #e2e8f0;
            margin-top: 10px;
            color: #667eea;
        }

        .tx-hash {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            padding: 10px;
            background: #f7fafc;
            border-radius: 4px;
            margin-top: 10px;
        }

        .info-box {
            background: #eef2ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 20px;
            font-size: 0.95rem;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .tier-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚õìÔ∏è Publish to Oak Chain</h1>
            <p class="tagline">Pay validators with MetaMask ‚Ä¢ Content stored on decentralized Oak</p>
        </header>

        <!-- Wallet Connection Status -->
        <div id="walletStatus" class="wallet-status disconnected">
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                ü¶ä MetaMask Status: <span id="walletStatusText">Not Connected</span>
            </div>
            <div id="walletAddressDisplay" class="wallet-address" style="display: none;"></div>
            <button id="connectWalletBtn" class="metamask" onclick="connectWallet()">
                Connect MetaMask
            </button>
        </div>

        <!-- Publish Form -->
        <!-- Three-Address Model Explanation -->
        <div class="card" style="background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-left: 4px solid #3b82f6;">
            <h2 style="margin-bottom: 15px; color: #1e40af;">üèóÔ∏è Three-Address Architecture</h2>
            <div style="display: grid; gap: 12px; font-size: 14px;">
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 20px;">üè¢</span>
                    <div>
                        <strong>Content Owner (Sling Author):</strong>
                        <div style="font-family: monospace; color: #1e40af; margin-top: 4px;" id="contentOwnerDisplay">
                            Loading...
                        </div>
                        <p style="color: #64748b; margin-top: 4px; font-size: 13px;">
                            Content will be stored at: <code>/oak-chain/content/{this-address}/...</code>
                        </p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 20px;">üë§</span>
                    <div>
                        <strong>Transaction Payer (You):</strong>
                        <div style="font-family: monospace; color: #1e40af; margin-top: 4px;" id="payerDisplay">
                            Connect MetaMask to see your address
                        </div>
                        <p style="color: #64748b; margin-top: 4px; font-size: 13px;">
                            Your wallet will pay for the transaction and be recorded as the publisher
                        </p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 20px;">‚ö°</span>
                    <div>
                        <strong>Validators:</strong>
                        <p style="color: #64748b; margin-top: 4px; font-size: 13px;">
                            Oak consensus validators receive payment and replicate content across the network
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px;">üì§ Content Details</h2>
            
            <div class="alert" id="alertBox"></div>

            <form id="publishForm">
                <div class="form-group">
                    <label for="contentPath">Content Path</label>
                    <input type="text" id="contentPath" placeholder="/content/my-page" required>
                    <small style="color: #718096; font-size: 0.875rem;">
                        The JCR path where your content will be stored
                    </small>
                </div>

                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" placeholder="My Amazing Content" required>
                </div>

                <div class="form-group">
                    <label for="contentBody">Content</label>
                    <textarea id="contentBody" placeholder="Enter your content here..." required></textarea>
                </div>

                <div class="form-group">
                    <label>Select Publishing Tier</label>
                    <div class="tier-selector">
                        <div class="tier-option selected" data-tier="0" onclick="selectTier(0)">
                            <div class="tier-name">üêå Standard</div>
                            <div class="tier-price">0.001 ETH</div>
                            <div class="tier-delay">~60s delay</div>
                        </div>
                        <div class="tier-option" data-tier="1" onclick="selectTier(1)">
                            <div class="tier-name">‚ö° Express</div>
                            <div class="tier-price">0.002 ETH</div>
                            <div class="tier-delay">~15s delay</div>
                        </div>
                        <div class="tier-option" data-tier="2" onclick="selectTier(2)">
                            <div class="tier-name">üöÄ Priority</div>
                            <div class="tier-price">0.01 ETH</div>
                            <div class="tier-delay">~5s delay</div>
                        </div>
                    </div>
                </div>

                <div class="cost-summary">
                    <h3 style="margin-bottom: 15px;">Cost Summary</h3>
                    <div class="cost-row">
                        <span>Publishing Tier:</span>
                        <span id="costTierName">Standard</span>
                    </div>
                    <div class="cost-row">
                        <span>Validator Payment:</span>
                        <span id="costPayment">0.001 ETH</span>
                    </div>
                    <div class="cost-row">
                        <span>Est. Gas Fee:</span>
                        <span id="costGas">~0.0005 ETH</span>
                    </div>
                    <div class="cost-row total">
                        <span>Total Cost:</span>
                        <span id="costTotal">~0.0015 ETH</span>
                    </div>
                </div>

                <button type="submit" id="publishBtn" disabled>
                    üí∞ Pay with MetaMask & Publish
                </button>

                <div class="info-box">
                    <strong>‚ÑπÔ∏è How it works:</strong><br>
                    1. MetaMask signs your transaction to the ValidatorPayment contract<br>
                    2. Validators receive payment and listen for the ProposalPaid event<br>
                    3. Content is replicated to all Oak validators via Aeron consensus<br>
                    4. Your content appears on the global /oak-chain mount
                </div>
            </form>
        </div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0x...'; // TODO: Replace with deployed ValidatorPaymentV3_1 address
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "bytes32", "name": "proposalId", "type": "bytes32"},
                    {"internalType": "uint8", "name": "tier", "type": "uint8"}
                ],
                "name": "payForProposal",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "bytes32", "name": "proposalId", "type": "bytes32"},
                    {"indexed": true, "internalType": "address", "name": "payer", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"},
                    {"indexed": false, "internalType": "uint8", "name": "tier", "type": "uint8"},
                    {"indexed": true, "internalType": "uint8", "name": "paymentToken", "type": "uint8"},
                    {"indexed": false, "internalType": "address", "name": "preferredValidator", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}
                ],
                "name": "ProposalPaid",
                "type": "event"
            }
        ];

        // Tier pricing in Wei
        const TIER_PRICES = {
            0: '1000000000000000',      // 0.001 ETH (Standard)
            1: '2000000000000000',      // 0.002 ETH (Express)
            2: '10000000000000000'      // 0.01 ETH (Priority)
        };

        const TIER_NAMES = ['Standard', 'Express', 'Priority'];

        let web3;
        let contract;
        let userAccount; // MetaMask payer address
        let selectedTier = 0;
        
        // CRITICAL: Sling Author's wallet address (content owner)
        // In production, this would be configured per AEM instance
        const SLING_AUTHOR_ADDRESS = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0'; // Example address
        
        // Three-address model:
        // 1. SLING_AUTHOR_ADDRESS = content owner (where content is stored on oak-chain)
        // 2. userAccount = payer (MetaMask user paying for transaction)
        // 3. Validator addresses = nodes receiving payment

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Display content owner address
            document.getElementById('contentOwnerDisplay').textContent = SLING_AUTHOR_ADDRESS;
            
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                
                // Check if already connected
                ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                    if (accounts.length > 0) {
                        handleAccountsChanged(accounts);
                    }
                });

                // Listen for account changes
                ethereum.on('accountsChanged', handleAccountsChanged);
                ethereum.on('chainChanged', () => window.location.reload());
            } else {
                showAlert('error', 'ü¶ä MetaMask not detected. Please install MetaMask to continue.');
            }

            // Form submission
            document.getElementById('publishForm').addEventListener('submit', handlePublish);
        });

        async function connectWallet() {
            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
            } catch (error) {
                showAlert('error', `Failed to connect wallet: ${error.message}`);
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // User disconnected
                document.getElementById('walletStatus').className = 'wallet-status disconnected';
                document.getElementById('walletStatusText').textContent = 'Not Connected';
                document.getElementById('walletAddressDisplay').style.display = 'none';
                document.getElementById('connectWalletBtn').style.display = 'block';
                document.getElementById('publishBtn').disabled = true;
                document.getElementById('payerDisplay').textContent = 'Connect MetaMask to see your address';
                userAccount = null;
            } else {
                // User connected
                userAccount = accounts[0];
                document.getElementById('walletStatus').className = 'wallet-status connected';
                document.getElementById('walletStatusText').textContent = 'Connected';
                document.getElementById('walletAddressDisplay').textContent = userAccount;
                document.getElementById('walletAddressDisplay').style.display = 'block';
                document.getElementById('connectWalletBtn').style.display = 'none';
                document.getElementById('publishBtn').disabled = false;
                document.getElementById('payerDisplay').textContent = userAccount;

                // Initialize contract
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
            }
        }

        function selectTier(tier) {
            selectedTier = tier;
            
            // Update UI
            document.querySelectorAll('.tier-option').forEach((el, index) => {
                el.classList.toggle('selected', index === tier);
            });

            // Update cost summary
            const tierName = TIER_NAMES[tier];
            // Safe check for web3 before using it
            if (web3 && web3.utils) {
                const ethPrice = web3.utils.fromWei(TIER_PRICES[tier], 'ether');
                
                document.getElementById('costTierName').textContent = tierName;
                document.getElementById('costPayment').textContent = `${ethPrice} ETH`;
                
                // Estimate total with gas
                const totalEstimate = parseFloat(ethPrice) + 0.0005;
                document.getElementById('costTotal').textContent = `~${totalEstimate.toFixed(4)} ETH`;
            }
        }

        async function handlePublish(e) {
            e.preventDefault();

            if (!userAccount) {
                showAlert('error', 'Please connect your MetaMask wallet first');
                return;
            }

            // Get form data
            const path = document.getElementById('contentPath').value;
            const title = document.getElementById('contentTitle').value;
            const content = document.getElementById('contentBody').value;

            // Generate proposal ID (hash of content path + timestamp)
            const proposalData = path + Date.now();
            const proposalId = web3.utils.soliditySha3(proposalData);

            try {
                showAlert('info', '‚è≥ Waiting for MetaMask confirmation...');
                document.getElementById('publishBtn').disabled = true;

                // Call contract payForProposal function
                const tx = await contract.methods.payForProposal(proposalId, selectedTier).send({
                    from: userAccount,
                    value: TIER_PRICES[selectedTier]
                });

                showAlert('success', `‚úÖ Transaction successful!<div class="tx-hash">Tx: ${tx.transactionHash}</div>`);

                // Submit content to Oak validators via Sling servlet
                await submitContentToOak(path, title, content, proposalId, tx.transactionHash);

                // Reset form
                document.getElementById('publishForm').reset();
                selectTier(0);

            } catch (error) {
                console.error('Transaction error:', error);
                
                if (error.code === 4001) {
                    showAlert('error', '‚ùå Transaction rejected by user');
                } else {
                    showAlert('error', `‚ùå Transaction failed: ${error.message}`);
                }
            } finally {
                document.getElementById('publishBtn').disabled = false;
            }
        }

        async function submitContentToOak(path, title, content, proposalId, txHash) {
            try {
                const response = await fetch('/bin/blockchain/oak-chain-publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        path: path,
                        title: title,
                        content: content,
                        proposalId: proposalId,
                        txHash: txHash,
                        tier: selectedTier,
                        // Three-address model
                        contentOwner: SLING_AUTHOR_ADDRESS,  // Sling Author (content owner)
                        paidBy: userAccount,                  // MetaMask user (payer)
                        wallet: userAccount                   // Legacy field for compatibility
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    console.warn('Content submission warning:', result.message);
                }
            } catch (error) {
                console.error('Failed to submit content to Oak:', error);
            }
        }

        function showAlert(type, message) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert ${type} show`;
            alertBox.innerHTML = message;
            
            if (type === 'success') {
                setTimeout(() => {
                    alertBox.classList.remove('show');
                }, 10000);
            }
        }
    </script>
</body>
</html>

