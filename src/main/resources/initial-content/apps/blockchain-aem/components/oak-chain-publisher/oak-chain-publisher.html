<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish to Oak Chain - MetaMask Integration</title>
    
    <!-- Web3.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/web3@4.3.0/dist/web3.min.js"></script>
    
    <!-- Load component CSS and JS (pure Sling - no AEM Granite dependencies) -->
    <link rel="stylesheet" href="/apps/blockchain-aem/components/oak-chain-publisher/clientlibs/css/styles.css">
    <script src="/apps/blockchain-aem/components/oak-chain-publisher/clientlibs/js/web3-config.js"></script>
    <script src="/apps/blockchain-aem/components/oak-chain-publisher/clientlibs/js/wallet-manager.js"></script>
    <script src="/apps/blockchain-aem/components/oak-chain-publisher/clientlibs/js/form-handler.js"></script>
    <script src="/apps/blockchain-aem/components/oak-chain-publisher/clientlibs/js/app.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>â›“ï¸ Publish to Oak Chain</h1>
            <p class="tagline">Pay validators with MetaMask â€¢ Content stored on decentralized Oak</p>
        </header>

        <!-- Wallet Connection Status -->
        <div id="walletStatus" class="wallet-status disconnected">
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                ğŸ¦Š MetaMask Status: <span id="walletStatusText">Not Connected</span>
            </div>
            <div id="walletAddressDisplay" class="wallet-address" style="display: none;"></div>
            <button id="connectWalletBtn" class="metamask" onclick="connectWallet(); return false;">
                Connect MetaMask
            </button>
        </div>

        <!-- Three-Address Model Explanation -->
        <div class="card" style="background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-left: 4px solid #3b82f6;">
            <h2 style="margin-bottom: 15px; color: #1e40af;">ğŸ—ï¸ Three-Address Architecture</h2>
            <div style="display: grid; gap: 12px; font-size: 14px;">
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 20px;">ğŸ¢</span>
                    <div>
                        <strong>Content Owner (Sling Author):</strong>
                        <div style="font-family: monospace; color: #1e40af; margin-top: 4px;" id="contentOwnerDisplay">
                            Loading...
                        </div>
                        <p style="color: #64748b; margin-top: 4px; font-size: 13px;">
                            Content will be stored at: <code>/oak-chain/content/{this-address}/...</code>
                        </p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 20px;">ğŸ‘¤</span>
                    <div>
                        <strong>Transaction Payer (You):</strong>
                        <div style="font-family: monospace; color: #1e40af; margin-top: 4px;" id="payerDisplay">
                            Connect MetaMask to see your address
                        </div>
                        <p style="color: #64748b; margin-top: 4px; font-size: 13px;">
                            Your wallet will pay for the transaction and be recorded as the publisher
                        </p>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 10px;">
                    <span style="font-size: 20px;">âš¡</span>
                    <div>
                        <strong>Validators:</strong>
                        <p style="color: #64748b; margin-top: 4px; font-size: 13px;">
                            Oak consensus validators receive payment and replicate content across the network
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Publish Form -->
        <div class="card">
            <h2 style="margin-bottom: 20px;">ğŸ“¤ Content Details</h2>
            
            <div class="alert" id="alertBox"></div>

            <form id="publishForm">
                <!-- Content Path -->
                <div class="form-group">
                    <label for="contentPath">Content Path</label>
                    <input type="text" id="contentPath" placeholder="/content/my-page" required>
                    <small style="color: #718096; font-size: 0.875rem;">
                        The JCR path where your content will be stored
                    </small>
                </div>

                <!-- Title -->
                <div class="form-group">
                    <label for="contentTitle">Title</label>
                    <input type="text" id="contentTitle" placeholder="My Amazing Content" required>
                </div>

                <!-- Content Body -->
                <div class="form-group">
                    <label for="contentBody">Content</label>
                    <textarea id="contentBody" placeholder="Enter your content here..." required></textarea>
                </div>

                <!-- Tier Selection -->
                <div class="form-group">
                    <label>Select Publishing Tier</label>
                    <div class="tier-selector">
                        <div class="tier-option selected" data-tier="0" onclick="selectTier(0)">
                            <div class="tier-name">ğŸŒ Standard</div>
                            <div class="tier-price">0.001 ETH</div>
                            <div class="tier-delay">2 epochs (~13 min)</div>
                        </div>
                        <div class="tier-option" data-tier="1" onclick="selectTier(1)">
                            <div class="tier-name">âš¡ Express</div>
                            <div class="tier-price">0.002 ETH</div>
                            <div class="tier-delay">1 epoch (~6.4 min)</div>
                        </div>
                        <div class="tier-option" data-tier="2" onclick="selectTier(2)">
                            <div class="tier-name">ğŸš€ Priority</div>
                            <div class="tier-price">0.01 ETH</div>
                            <div class="tier-delay">Current epoch (immediate)</div>
                        </div>
                    </div>
                </div>

                <!-- Cost Summary -->
                <div class="cost-summary">
                    <h3 style="margin-bottom: 15px;">Cost Summary</h3>
                    <div class="cost-row">
                        <span>Publishing Tier:</span>
                        <span id="costTierName">Standard</span>
                    </div>
                    <div class="cost-row">
                        <span>Validator Payment:</span>
                        <span id="costPayment">0.001 ETH</span>
                    </div>
                    <div class="cost-row">
                        <span>Est. Gas Fee:</span>
                        <span id="costGas">~0.0005 ETH</span>
                    </div>
                    <div class="cost-row total">
                        <span>Total Cost:</span>
                        <span id="costTotal">~0.0015 ETH</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="publishBtn" disabled>
                    ğŸ’° Pay with MetaMask & Publish
                </button>

                <!-- Info Box -->
                <div class="info-box">
                    <strong>â„¹ï¸ How it works:</strong><br>
                    1. MetaMask signs your transaction to the ValidatorPayment contract<br>
                    2. Validators receive payment and listen for the ProposalPaid event<br>
                    3. Content is replicated to all Oak validators via Aeron consensus<br>
                    4. Your content appears on the global /oak-chain mount<br><br>
                    <strong>â±ï¸ Epoch-based timing:</strong><br>
                    â€¢ 1 Ethereum epoch = 32 slots Ã— 12 seconds = 384 seconds (~6.4 minutes)<br>
                    â€¢ Standard tier: Wait for finalization (2 epochs for security)<br>
                    â€¢ Express tier: Next epoch (faster, less confirmations)<br>
                    â€¢ Priority tier: Current epoch (immediate inclusion)
                </div>
            </form>
        </div>
    </div>
</body>
</html>

