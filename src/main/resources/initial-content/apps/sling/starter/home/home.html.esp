<!DOCTYPE html>
<!--
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain AEM | Sign In</title>
    <style>
        /* Blockchain AEM Login Page - AEM-inspired aesthetic */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            background-color: #000 !important;
            font-family: 'Adobe Clean', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 16px;
            height: 100%;
            overflow: hidden;
        }
        
        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 25%, #0f3460 50%, #16213e 75%, #0a0a0a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Adobe-style logo tag - top right */
        #tag {
            position: fixed;
            top: 0;
            right: 80px;
            width: 40px;
            height: 64px;
            background: #EB1000;
            z-index: 1000;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 85%, 0 100%);
        }
        
        /* AEM-style right-aligned login panel */
        #login-box {
            position: fixed;
            top: 50%;
            right: 60px;
            transform: translateY(-50%);
            z-index: 100;
            width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 48px;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.6),
                0 0 120px rgba(102, 126, 234, 0.12);
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }
        
        .header h1 {
            color: #ffffff;
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 32px;
        }
        
        .auth-description {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .fingerprint-icon {
            color: #5e72e4;
            margin-bottom: 16px;
        }
        
        .auth-description h2 {
            color: #ffffff;
            font-size: 20px;
            font-weight: 400;
            margin-bottom: 8px;
        }
        
        .auth-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .primary-button, .secondary-button {
            width: 100%;
            padding: 16px 24px;
            font-size: 15px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .primary-button {
            background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
            color: white;
        }
        
        .primary-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(94, 114, 228, 0.4);
        }
        
        .secondary-button {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .secondary-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .button-icon {
            margin-right: 8px;
            width: 20px;
            height: 20px;
        }
        
        .divider {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            margin: 24px 0;
            font-size: 13px;
        }
        
        .create-account {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .create-account a {
            color: #5e72e4;
            text-decoration: none;
            font-weight: 500;
        }
        
        .create-account a:hover {
            text-decoration: underline;
        }
        
        /* AEM-style footer - fixed at bottom left */
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 600px;
            z-index: 100;
            padding: 16px 32px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .legal-footer {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .legal-footer a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .legal-footer a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .separator {
            color: rgba(255, 255, 255, 0.3);
        }
        
        /* Responsive - center on mobile */
        @media (max-width: 768px) {
            #login-box {
                position: fixed;
                top: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 420px;
                border-radius: 12px;
                padding: 32px;
            }
            
            #footer {
                right: 0;
            }
            
            #tag {
                right: auto;
                left: 12px;
                top: 12px;
                width: 36px;
                height: 56px;
            }
        }
        
        #status-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        #status-content {
            background: rgba(30, 30, 40, 0.98);
            padding: 48px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }
        
        #status-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        #status-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 12px;
        }
        
        #status-message {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            margin-bottom: 24px;
        }
        
        #status-ok-btn {
            background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
        
        #status-ok-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(94, 114, 228, 0.4);
        }
    </style>
</head>
<body>
    <!-- Adobe-style logo tag -->
    <div id="tag"></div>
    
    <!-- Background gradient -->
    <div id="background"></div>
    
    <!-- Login box -->
    <div id="login-box">
        <div class="header">
            <h1>Welcome to Blockchain AEM</h1>
            <p>Sign in with your biometric credentials</p>
        </div>
        
        <!-- Biometric Authentication Section -->
        <div id="biometric-section">
            <div class="auth-description">
                <svg class="fingerprint-icon" viewBox="0 0 24 24" width="48" height="48">
                    <path fill="currentColor" d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.70-.23.16-.54.11-.70-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.40.01-1.36.70-2.5 1.70-3.40 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.10-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.10-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.10.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.10-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.70 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.80 0 .78.07 2.01.67 3.61.10.26-.03.55-.29.64-.26.10-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.20.23-2.29.68-3.24 1.33-2.79 4.28-4.60 7.51-4.60 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"/>
                </svg>
                <h2>Biometric Authentication</h2>
                <p class="auth-subtitle">Use your device's Face ID, Touch ID, or Windows Hello to securely access Blockchain AEM</p>
            </div>
            
            <!-- Status message -->
            <div id="auth-status" class="auth-status" hidden>
                <div class="status-content"></div>
            </div>
            
            <!-- Primary action button -->
            <button id="biometric-signin-btn" class="primary-button">
                <svg class="button-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                </svg>
                Sign In with Biometrics
            </button>
            
            <!-- Secondary options -->
            <div class="divider">
                <span>or</span>
            </div>
            
            <button id="metamask-signin-btn" class="secondary-button">
                <svg class="button-icon" viewBox="0 0 318.6 318.6" width="20" height="20" style="margin-right: 8px;">
                    <!-- MetaMask Fox Logo -->
                    <polygon fill="#E2761B" stroke="#E2761B" points="274.1,35.5 174.6,109.4 193,65.8"/>
                    <g>
                        <polygon fill="#E4761B" stroke="#E4761B" points="44.4,35.5 143.1,110.1 125.6,65.8"/>
                        <polygon fill="#E4761B" stroke="#E4761B" points="238.3,206.8 211.8,247.4 268.5,263 284.8,207.7"/>
                        <polygon fill="#E4761B" stroke="#E4761B" points="33.9,207.7 50.1,263 106.8,247.4 80.3,206.8"/>
                        <polygon fill="#E4761B" stroke="#E4761B" points="103.6,138.2 87.8,162.1 144.1,164.6 142.1,104.1"/>
                        <polygon fill="#E4761B" stroke="#E4761B" points="214.9,138.2 175.9,103.4 174.6,164.6 230.8,162.1"/>
                        <polygon fill="#E4761B" stroke="#E4761B" points="106.8,247.4 140.6,230.9 111.4,208.1"/>
                        <polygon fill="#E4761B" stroke="#E4761B" points="177.9,230.9 211.8,247.4 207.1,208.1"/>
                    </g>
                    <g>
                        <polygon fill="#D7C1B3" stroke="#D7C1B3" points="211.8,247.4 177.9,230.9 180.6,253 180.3,262.3"/>
                        <polygon fill="#D7C1B3" stroke="#D7C1B3" points="106.8,247.4 138.3,262.3 138.1,253 140.6,230.9"/>
                    </g>
                    <polygon fill="#233447" stroke="#233447" points="138.8,193.5 110.6,185.2 130.5,176.1"/>
                    <polygon fill="#233447" stroke="#233447" points="179.7,193.5 188,176.1 208,185.2"/>
                    <g>
                        <polygon fill="#CD6116" stroke="#CD6116" points="106.8,247.4 111.6,206.8 80.3,207.7"/>
                        <polygon fill="#CD6116" stroke="#CD6116" points="207,206.8 211.8,247.4 238.3,207.7"/>
                        <polygon fill="#CD6116" stroke="#CD6116" points="230.8,162.1 174.6,164.6 179.8,193.5 188.1,176.1 208.1,185.2"/>
                        <polygon fill="#CD6116" stroke="#CD6116" points="110.6,185.2 130.6,176.1 138.8,193.5 144.1,164.6 87.8,162.1"/>
                    </g>
                    <g>
                        <polygon fill="#E4751F" stroke="#E4751F" points="87.8,162.1 111.4,208.1 110.6,185.2"/>
                        <polygon fill="#E4751F" stroke="#E4751F" points="208.1,185.2 207.1,208.1 230.8,162.1"/>
                        <polygon fill="#E4751F" stroke="#E4751F" points="144.1,164.6 138.8,193.5 145.4,227.6 146.9,182.7"/>
                        <polygon fill="#E4751F" stroke="#E4751F" points="174.6,164.6 171.9,182.6 173.1,227.6 179.8,193.5"/>
                    </g>
                    <polygon fill="#F6851B" stroke="#F6851B" points="179.8,193.5 173.1,227.6 177.9,230.9 207.1,208.1 208.1,185.2"/>
                    <polygon fill="#F6851B" stroke="#F6851B" points="110.6,185.2 111.4,208.1 140.6,230.9 145.4,227.6 138.8,193.5"/>
                    <polygon fill="#C0AD9E" stroke="#C0AD9E" points="180.3,262.3 180.6,253 178.1,250.8 140.4,250.8 138.1,253 138.3,262.3 106.8,247.4 117.8,256.4 140.1,271.9 178.4,271.9 200.8,256.4 211.8,247.4"/>
                    <polygon fill="#161616" stroke="#161616" points="177.9,230.9 173.1,227.6 145.4,227.6 140.6,230.9 138.1,253 140.4,250.8 178.1,250.8 180.6,253"/>
                    <g>
                        <polygon fill="#763D16" stroke="#763D16" points="278.3,114.2 286.8,73.4 274.1,35.5 177.9,106.9 214.9,138.2 267.2,153.5 278.8,140 273.8,136.4 281.8,129.1 275.6,124.3 283.6,118.2"/>
                        <polygon fill="#763D16" stroke="#763D16" points="31.8,73.4 40.3,114.2 34.9,118.2 42.9,124.3 36.8,129.1 44.8,136.4 39.8,140 51.3,153.5 103.6,138.2 140.6,106.9 44.4,35.5"/>
                    </g>
                    <polygon fill="#F6851B" stroke="#F6851B" points="267.2,153.5 214.9,138.2 230.8,162.1 207.1,208.1 238.3,207.7 284.8,207.7"/>
                    <polygon fill="#F6851B" stroke="#F6851B" points="103.6,138.2 51.3,153.5 33.9,207.7 80.3,207.7 111.4,208.1 87.8,162.1"/>
                    <polygon fill="#F6851B" stroke="#F6851B" points="174.6,164.6 177.9,106.9 193.1,65.8 125.6,65.8 140.6,106.9 144.1,164.6 145.3,182.8 145.4,227.6 173.1,227.6 173.3,182.8"/>
                </svg>
                Sign In with MetaMask
            </button>
            
            <!-- Registration link -->
            <p class="create-account">
                New to Blockchain AEM? 
                <a href="/content/blockchain-aem/register.html">Create an account</a>
            </p>
        </div>
    </div>
    
    <!-- Footer -->
    <div id="footer">
        <div class="legal-footer">
            <span>&copy; 2025 Blockchain AEM. Powered by Apache Jackrabbit Oak</span>
            <span class="separator">|</span>
            <a href="/about.html">About</a>
            <span class="separator">|</span>
            <a href="/content/blockchain-aem/">Dashboard</a>
            <span class="separator">|</span>
            <a href="https://github.com/apache/jackrabbit-oak">GitHub</a>
        </div>
    </div>
    
    <!-- Modal for status messages -->
    <div id="status-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding:40px; border-radius:20px; max-width:500px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <div id="status-icon" style="font-size:64px; margin-bottom:20px;"></div>
            <h2 id="status-title" style="color:#fff; margin:0 0 10px 0; font-size:24px;"></h2>
            <p id="status-message" style="color:#a0a0b0; margin:0 0 20px 0; font-size:16px;"></p>
            <button id="status-ok-btn" onclick="document.getElementById('status-modal').style.display='none'" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; padding:12px 30px; border-radius:8px; font-size:16px; cursor:pointer; display:none;">OK</button>
        </div>
    </div>

    <!-- Load biometric wallet creation -->
    <script src="/apps/blockchain-aem/components/login/clientlibs/js/biometric-wallet-creation.js"></script>
    
    <!-- Load dependencies -->
    <script>
        function showStatus(icon, title, message, showOkButton) {
            const modal = document.getElementById('status-modal');
            document.getElementById('status-icon').textContent = icon;
            document.getElementById('status-title').textContent = title;
            document.getElementById('status-message').textContent = message;
            document.getElementById('status-ok-btn').style.display = showOkButton ? 'inline-block' : 'none';
            modal.style.display = 'flex';
        }
        
        /**
         * Convert base64url to standard base64
         * WebAuthn credential.id is base64url-encoded, but atob() expects standard base64.
         * - base64url uses: - and _ (URL-safe)
         * - base64 uses: + and / (standard)
         */
        function base64UrlToBase64(base64url) {
            // Replace URL-safe chars with standard base64 chars
            let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            // Add padding if needed
            const pad = base64.length % 4;
            if (pad) {
                base64 += '='.repeat(4 - pad);
            }
            return base64;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const biometricBtn = document.getElementById('biometric-signin-btn');
            const metamaskBtn = document.getElementById('metamask-signin-btn');
            
            biometricBtn.addEventListener('click', async function() {
                const btn = biometricBtn;
                
                try {
                    // Check if WebAuthn is supported
                    if (!window.PublicKeyCredential) {
                        showStatus('‚ùå', 'Biometric Not Supported', 
                            'Your browser or device does not support biometric authentication.\n\n' +
                            'Please use MetaMask instead or try a different browser.', true);
                        return;
                    }
                    
                    // Check if user has registered biometric credential
                    const credentialId = localStorage.getItem('blockchain_aem_biometric_credential_id');
                    const walletAddress = localStorage.getItem('blockchain_aem_biometric_wallet');
                    
                    if (!credentialId || !walletAddress) {
                        showStatus('üîê', 'No Biometric Registered', 
                            'You haven\'t registered a biometric credential yet.\n\n' +
                            'Please create an account first by clicking "Create an account" below.', true);
                        return;
                    }
                    
                    // Disable button and show loading
                    btn.disabled = true;
                    btn.innerHTML = '<span class="button-icon">‚è≥</span> Authenticating...';
                    
                    // Generate challenge for this authentication attempt
                    const challenge = new Uint8Array(32);
                    crypto.getRandomValues(challenge);
                    
                    // Prompt for biometric authentication
                    showStatus('üëÜ', 'Biometric Authentication', 
                        'Please authenticate with your Face ID, Touch ID, or fingerprint sensor.', false);
                    
                    const credential = await navigator.credentials.get({
                        publicKey: {
                            challenge: challenge,
                            allowCredentials: [{
                                type: 'public-key',
                                id: Uint8Array.from(atob(base64UrlToBase64(credentialId)), c => c.charCodeAt(0))
                            }],
                            userVerification: 'required',
                            timeout: 60000
                        }
                    });
                    
                    if (!credential) {
                        throw new Error('No credential returned from authenticator');
                    }
                    
                    // Extract assertion data
                    const response = credential.response;
                    const signature = new Uint8Array(response.signature);
                    const authenticatorData = new Uint8Array(response.authenticatorData);
                    const clientDataJSON = new Uint8Array(response.clientDataJSON);
                    
                    // Get stored public key
                    const publicKeyBase64 = localStorage.getItem('blockchain_aem_biometric_pubkey');
                    
                    if (!publicKeyBase64) {
                        throw new Error('Public key not found in local storage');
                    }
                    
                    // Send to backend for verification
                    showStatus('üîê', 'Verifying Credentials...', 
                        'Validating your biometric signature with Oak JAAS...', false);
                    
                    const loginResponse = await fetch('/bin/blockchain-aem/biometric-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: walletAddress,
                            credentialId: credentialId,
                            signature: btoa(String.fromCharCode.apply(null, signature)),
                            challenge: btoa(String.fromCharCode.apply(null, challenge)),
                            publicKey: publicKeyBase64,
                            authenticatorData: btoa(String.fromCharCode.apply(null, authenticatorData)),
                            clientDataJSON: btoa(String.fromCharCode.apply(null, clientDataJSON))
                        })
                    });
                    
                    if (!loginResponse.ok) {
                        const errorData = await loginResponse.json();
                        throw new Error(errorData.error || 'Authentication failed');
                    }
                    
                    const result = await loginResponse.json();
                    
                    // Success!
                    showStatus('‚úÖ', 'Authentication Successful', 
                        'Welcome back!\n' +
                        'Wallet: ' + walletAddress.substring(0, 10) + '...\n\n' +
                        'Redirecting to dashboard...', false);
                    
                    // Redirect after 2 seconds to Composum Browser
                    setTimeout(function() {
                        window.location.href = '/bin/browser.html/content/blockchain-aem';
                    }, 2000);
                    
                } catch (error) {
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="button-icon" viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg> Sign In with Biometrics';
                    
                    if (error.name === 'NotAllowedError') {
                        showStatus('‚ùå', 'Authentication Cancelled', 
                            'You cancelled the biometric authentication.', true);
                    } else {
                        showStatus('‚ùå', 'Authentication Failed', 
                            'Error: ' + error.message + '\n\n' +
                            'If you just registered, please sign in with MetaMask first.', true);
                    }
                }
            });
            
            metamaskBtn.addEventListener('click', async function() {
                const btn = metamaskBtn;
                
                try {
                    // Check if MetaMask is installed
                    if (!window.ethereum) {
                        showStatus('ü¶ä', 'MetaMask Not Found', 
                            'Please install the MetaMask browser extension to continue.', true);
                        window.open('https://metamask.io', '_blank');
                        return;
                    }
                    
                    // Disable button and show loading
                    btn.disabled = true;
                    btn.innerHTML = '<span class="button-icon">‚è≥</span> Opening MetaMask...';
                    
                    // Step 1: Request accounts (opens MetaMask popup)
                    showStatus('ü¶ä', 'Opening MetaMask...', 
                        'Please check your MetaMask extension and approve the connection request.', false);
                    
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    const userAddress = accounts[0];
                    
                    // Step 2: Request signature (proof of ownership)
                    showStatus('‚úçÔ∏è', 'Sign Authentication Message', 
                        'Please sign the message in MetaMask to prove you own this wallet.', false);
                    
                    const message = 'Sign in to Blockchain AEM\nWallet: ' + userAddress + '\nTimestamp: ' + Date.now();
                    const signature = await window.ethereum.request({
                        method: 'personal_sign',
                        params: [message, userAddress]
                    });
                    
                    // Step 3: Send to Sling for verification and session creation
                    showStatus('üîê', 'Authenticating...', 
                        'Verifying signature and creating session...', false);
                    
                    const response = await fetch('/bin/blockchain-aem/metamask-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            address: userAddress, 
                            signature: signature,
                            message: message 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Authentication failed: ' + response.statusText);
                    }
                    
                    const result = await response.json();
                    
                    // Store wallet for later use
                    localStorage.setItem('blockchain_aem_wallet', userAddress);
                    
                    // Show success
                    showStatus('‚úÖ', 'Connected Successfully', 
                        'Wallet: ' + userAddress.substring(0, 6) + '...' + userAddress.substring(38) + '\n\n' +
                        'Redirecting to dashboard...', false);
                    
                    // Redirect after 2 seconds to Composum Browser
                    setTimeout(function() {
                        window.location.href = '/bin/browser.html/content/blockchain-aem';
                    }, 2000);
                    
                } catch (error) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="button-icon">ü¶ä</span> Sign In with MetaMask';
                    
                    if (error.code === 4001) {
                        showStatus('‚ùå', 'Connection Rejected', 
                            'You rejected the request in MetaMask.', true);
                    } else {
                        showStatus('‚ùå', 'Connection Failed', 
                            'Error: ' + error.message, true);
                    }
                }
            });
        });
    </script>
</body>
</html>
